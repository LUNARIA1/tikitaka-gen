<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoverse Pro - 리치 텍스트 메모</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        
        /* 에디터 스타일 */
        .editor-content {
            min-height: 200px;
            outline: none;
            line-height: 1.6;
        }
        .editor-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: default; /* 에디터 내에서는 클릭 이벤트 방지 */
        }
        .editor-content p { margin-bottom: 0.5rem; }
        
        /* 스크롤바 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* 대표 이미지 선택 스타일 */
        .cover-option {
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .cover-option.selected {
            border-color: #4f46e5; /* Indigo-600 */
            transform: scale(1.05);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- 헤더 -->
    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md border-b border-slate-200 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-200">M</div>
                <span class="text-xl font-bold text-slate-900">Memoverse <span class="text-xs font-normal text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full">Pro</span></span>
            </div>
            <button onclick="openModal()" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-lg shadow-slate-200 transform hover:-translate-y-0.5 flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> 작성하기
            </button>
        </div>
    </nav>

    <!-- 메인 그리드 -->
    <main class="pt-24 pb-12 px-4 max-w-7xl mx-auto min-h-screen">
        <div id="memo-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- 카드가 렌더링되는 곳 -->
        </div>

        <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32 text-slate-400">
            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                <i class="fa-regular fa-folder-open text-3xl text-slate-300"></i>
            </div>
            <p class="text-lg font-medium text-slate-500">아직 기록된 메모가 없습니다.</p>
            <p class="text-sm">사진과 글을 자유롭게 남겨보세요.</p>
        </div>
    </main>

    <!-- 작성/수정 모달 -->
    <div id="memo-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-100">
                    
                    <!-- 모달 헤더 -->
                    <div class="bg-white px-6 pt-6 pb-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-slate-900" id="modal-title">메모 작성</h3>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
                    </div>
                    
                    <div class="px-6 py-4 space-y-4">
                        <!-- 제목 -->
                        <input type="text" id="input-title" class="block w-full text-lg font-bold border-none focus:ring-0 p-0 placeholder:text-slate-300 text-slate-900" placeholder="제목을 입력하세요">

                        <!-- 툴바 -->
                        <div class="flex items-center gap-1 bg-slate-50 p-1.5 rounded-lg border border-slate-200 sticky top-0 z-10">
                            <button onclick="execCmd('bold')" class="p-2 rounded hover:bg-white hover:shadow-sm text-slate-600 transition-all" title="굵게"><i class="fa-solid fa-bold"></i></button>
                            <button onclick="execCmd('italic')" class="p-2 rounded hover:bg-white hover:shadow-sm text-slate-600 transition-all" title="기울임"><i class="fa-solid fa-italic"></i></button>
                            <div class="w-px h-5 bg-slate-300 mx-1"></div>
                            <label class="cursor-pointer p-2 rounded hover:bg-white hover:shadow-sm text-indigo-600 transition-all flex items-center gap-2" title="사진 추가">
                                <i class="fa-regular fa-image"></i>
                                <span class="text-xs font-bold">사진 추가</span>
                                <input type="file" accept="image/*" multiple class="hidden" onchange="handleImageInsert(this)">
                            </label>
                        </div>

                        <!-- 에디터 본문 (contenteditable) -->
                        <div id="editor" class="editor-content w-full text-slate-700 placeholder:text-slate-400 empty:before:content-[attr(placeholder)] empty:before:text-slate-300 cursor-text" contenteditable="true" placeholder="내용을 자유롭게 작성하세요..." oninput="detectImages()"></div>

                        <!-- 대표 이미지 선택 영역 -->
                        <div id="cover-selection-area" class="hidden pt-4 border-t border-slate-100">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">대표 이미지 선택</p>
                            <div id="image-list" class="flex gap-3 overflow-x-auto pb-2">
                                <!-- 이미지들이 여기에 나열됨 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 하단 버튼 -->
                    <div class="bg-slate-50 px-6 py-4 flex flex-row-reverse gap-3">
                        <button type="button" onclick="saveMemo()" class="rounded-xl bg-slate-900 px-6 py-2.5 text-sm font-bold text-white shadow-md hover:bg-slate-800 hover:shadow-lg transition-all">저장 완료</button>
                        <button type="button" onclick="closeModal()" class="rounded-xl bg-white border border-slate-200 px-6 py-2.5 text-sm font-bold text-slate-600 hover:bg-slate-50 transition-all">취소</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 전역 변수 ---
        let memos = JSON.parse(localStorage.getItem('memoverse_pro_memos')) || [];
        let editingId = null;
        let selectedCoverSrc = null; // 현재 선택된 대표 이미지 소스

        const grid = document.getElementById('memo-grid');
        const emptyState = document.getElementById('empty-state');
        const modal = document.getElementById('memo-modal');
        const editor = document.getElementById('editor');
        const imageList = document.getElementById('image-list');
        const coverArea = document.getElementById('cover-selection-area');

        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', renderMemos);

        // --- 에디터 기능 ---
        
        // 텍스트 스타일 적용 (굵게, 기울임 등)
        function execCmd(command) {
            document.execCommand(command, false, null);
            editor.focus();
        }

        // 이미지 파일 삽입 처리
        function handleImageInsert(input) {
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgHtml = `<img src="${e.target.result}" class="mx-auto">`;
                        insertHtmlAtCursor(imgHtml);
                        detectImages(); // 이미지 삽입 후 목록 갱신
                    };
                    reader.readAsDataURL(file);
                });
                input.value = ''; // 초기화
            }
        }

        // 커서 위치에 HTML 삽입 (핵심)
        function insertHtmlAtCursor(html) {
            editor.focus();
            const sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                const el = document.createElement("div");
                el.innerHTML = html;
                const frag = document.createDocumentFragment();
                let node, lastNode;
                while ((node = el.firstChild)) {
                    lastNode = frag.appendChild(node);
                }
                range.insertNode(frag);
                
                // 커서를 삽입된 요소 뒤로 이동
                if (lastNode) {
                    range.setStartAfter(lastNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            } else {
                // 포커스가 없으면 맨 뒤에 추가
                editor.innerHTML += html;
            }
        }

        // 에디터 내 이미지 감지 및 대표 이미지 UI 생성
        function detectImages() {
            const imgs = editor.getElementsByTagName('img');
            const srcList = Array.from(imgs).map(img => img.src);

            if (srcList.length > 0) {
                coverArea.classList.remove('hidden');
                renderCoverSelector(srcList);
            } else {
                coverArea.classList.add('hidden');
                selectedCoverSrc = null;
            }
        }

        // 대표 이미지 선택 UI 렌더링
        function renderCoverSelector(srcList) {
            imageList.innerHTML = '';
            
            // 만약 선택된 이미지가 없거나, 삭제되어 목록에 없다면 첫번째를 기본값으로
            if (!selectedCoverSrc || !srcList.includes(selectedCoverSrc)) {
                selectedCoverSrc = srcList[0];
            }

            srcList.forEach((src, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = `flex-shrink-0 cursor-pointer relative group`;
                wrapper.onclick = () => {
                    selectedCoverSrc = src;
                    renderCoverSelector(srcList); // 다시 그려서 스타일 업데이트
                };

                const isSelected = (src === selectedCoverSrc);
                
                wrapper.innerHTML = `
                    <img src="${src}" class="w-16 h-16 object-cover rounded-lg cover-option ${isSelected ? 'selected' : 'opacity-70 hover:opacity-100'}">
                    ${isSelected ? '<div class="absolute -top-2 -right-2 bg-indigo-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full shadow-sm"><i class="fa-solid fa-check"></i></div>' : ''}
                `;
                imageList.appendChild(wrapper);
            });
        }


        // --- 모달 관련 ---
        function openModal(id = null) {
            editingId = id;
            document.getElementById('input-title').value = '';
            editor.innerHTML = '';
            selectedCoverSrc = null;
            coverArea.classList.add('hidden');

            if (id) {
                const memo = memos.find(m => m.id === id);
                if (memo) {
                    document.getElementById('modal-title').innerText = '메모 수정';
                    document.getElementById('input-title').value = memo.title;
                    editor.innerHTML = memo.content;
                    selectedCoverSrc = memo.coverImage || null;
                    detectImages(); // 기존 이미지 로드 및 선택 상태 복구
                }
            } else {
                document.getElementById('modal-title').innerText = '새 메모 작성';
            }
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        // --- 저장 및 삭제 ---
        function saveMemo() {
            const title = document.getElementById('input-title').value.trim();
            const content = editor.innerHTML;
            const textContent = editor.innerText.trim();

            // 이미지가 있는지 확인
            const imgs = editor.getElementsByTagName('img');
            const hasImage = imgs.length > 0;

            if (!title && !textContent && !hasImage) {
                alert('내용을 입력해주세요.');
                return;
            }

            // 대표 이미지 확정 (UI에서 선택된 것, 없으면 첫번째)
            let finalCover = null;
            if (hasImage) {
                finalCover = selectedCoverSrc || imgs[0].src;
            }

            const now = new Date().toLocaleString('ko-KR', {
                year: '2-digit', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit'
            });

            const memoData = {
                id: editingId || Date.now(),
                title,
                content, // HTML 전체 저장
                coverImage: finalCover,
                date: now
            };

            if (editingId) {
                const index = memos.findIndex(m => m.id === editingId);
                memos[index] = memoData;
            } else {
                memos.unshift(memoData);
            }

            localStorage.setItem('memoverse_pro_memos', JSON.stringify(memos));
            renderMemos();
            closeModal();
        }

        function deleteMemo(id, e) {
            e.stopPropagation();
            if(confirm('이 메모를 삭제하시겠습니까?')) {
                memos = memos.filter(m => m.id !== id);
                localStorage.setItem('memoverse_pro_memos', JSON.stringify(memos));
                renderMemos();
            }
        }

        // --- 리스트 렌더링 (핵심 로직) ---
        function renderMemos() {
            grid.innerHTML = '';
            if (memos.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            memos.forEach(memo => {
                // 1. HTML 파싱하여 실제 이미지 개수 파악
                const parser = new DOMParser();
                const doc = parser.parseFromString(memo.content, 'text/html');
                const imgs = doc.getElementsByTagName('img');
                const imgCount = imgs.length;
                
                // 2. 본문 텍스트만 추출 (미리보기용)
                const plainText = doc.body.textContent || "";

                // 3. 이미지 렌더링 로직
                let imageSection = '';
                if (imgCount > 0 && memo.coverImage) {
                    const extraCount = imgCount - 1;
                    const badgeHtml = extraCount > 0 
                        ? `<div class="absolute bottom-2 right-2 bg-black/60 backdrop-blur-sm text-white text-xs font-bold px-2 py-1 rounded-md">+${extraCount}</div>` 
                        : '';
                    
                    imageSection = `
                        <div class="relative h-48 w-full bg-slate-100 overflow-hidden border-b border-slate-100">
                            <img src="${memo.coverImage}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                            ${badgeHtml}
                        </div>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'group bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-xl hover:shadow-slate-200/50 transition-all duration-300 cursor-pointer hover:-translate-y-1 flex flex-col';
                card.onclick = () => openModal(memo.id);

                card.innerHTML = `
                    ${imageSection}
                    <div class="p-5 flex-1 flex flex-col">
                        <h3 class="text-lg font-bold text-slate-900 mb-2 line-clamp-1">${memo.title || '제목 없음'}</h3>
                        <p class="text-slate-500 text-sm line-clamp-3 mb-4 flex-1 leading-relaxed">${plainText || (imgCount > 0 ? '(사진만 있는 메모)' : '내용 없음')}</p>
                        
                        <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-50">
                            <span class="text-xs font-medium text-slate-400 bg-slate-50 px-2 py-1 rounded-md">${memo.date}</span>
                            <button onclick="deleteMemo(${memo.id}, event)" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    </script>
</body>
</html>