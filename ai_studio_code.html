<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoverse Final - Font Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        
        .editor-content { min-height: 300px; outline: none; line-height: 1.7; padding: 1rem; font-size: 16px; color: #334155; }
        .editor-content[contenteditable="false"] { background-color: #fff; cursor: default; }
        .editor-content img { max-width: 100%; border-radius: 8px; margin: 12px 0; box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.1); display: inline-block; }
        .editor-content img:hover { box-shadow: 0 0 0 3px #6366f1; }
        
        .toolbar-btn { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 6px; color: #475569; transition: all 0.2s; font-size: 15px; cursor: pointer; }
        .toolbar-btn:hover { background-color: #e2e8f0; color: #0f172a; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .asset-item { transition: all 0.2s; border: 2px solid transparent; }
        .asset-item:hover { transform: translateY(-2px); }
        .asset-item.is-cover { border-color: #4f46e5; }

        .color-picker-wrapper { position: relative; overflow: hidden; }
        .color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        #loading-screen {
            position: fixed; inset: 0; background: rgba(255,255,255,1); 
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem;
            transition: opacity 0.3s;
        }
    </style>
    <!-- ì‚¬ìš©ì í°íŠ¸ê°€ ë¡œë“œë  ê³µê°„ -->
    <div id="dynamic-fonts"></div>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        <p id="loading-text" class="text-slate-500 text-sm">Memoverse ì‹¤í–‰ ì¤‘...</p>
    </div>

    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="h-16 bg-white/90 backdrop-blur-sm border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-indigo-900 rounded-lg flex items-center justify-center text-white font-bold shadow-md">M</div>
            <h1 class="text-xl font-bold tracking-tight text-slate-900">Memoverse <span id="storage-badge" class="text-xs font-normal bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">Ready</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="openSettings()" class="text-slate-500 hover:text-slate-800 w-10 h-10 rounded-full hover:bg-slate-100 transition-all">
                <i class="fa-solid fa-gear"></i>
            </button>
            <button onclick="openCreateModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-bold transition-all shadow-lg hover:-translate-y-0.5 flex items-center gap-2">
                <i class="fa-solid fa-pen"></i> ìƒˆ ë©”ëª¨
            </button>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="flex-1 overflow-y-auto p-6">
        <div id="memo-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto"></div>
        <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-slate-400 mt-20">
            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                <i class="fa-regular fa-folder-open text-3xl text-slate-300"></i>
            </div>
            <p class="text-lg font-medium">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </main>

    <!-- ëª¨ë‹¬ -->
    <div id="memo-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative w-full max-w-5xl bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] border border-slate-100">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                        <input type="text" id="input-title" class="bg-transparent text-xl font-bold text-slate-900 placeholder:text-slate-300 outline-none w-full" placeholder="ì œëª© ì…ë ¥">
                        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-50 flex items-center justify-center shrink-0 ml-2"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <div id="toolbar" class="px-4 py-2 border-b border-slate-100 bg-slate-50/80 flex flex-wrap gap-1 items-center sticky top-0 z-20 backdrop-blur-sm transition-all duration-200">
                        <select id="fontFamilySelect" onchange="formatDoc('fontName', this.value);" class="h-9 text-sm border border-slate-200 rounded-md px-2 w-32 outline-none bg-white mr-1"><option value="" disabled selected>í°íŠ¸</option></select>
                        <select onchange="changeFontSize(this.value); this.selectedIndex=0;" class="h-9 text-sm border border-slate-200 rounded-md px-2 w-20 outline-none bg-white mr-2"><option value="" disabled selected>í¬ê¸°</option><option value="12">12</option><option value="14">14</option><option value="18">18</option><option value="24">24</option><option value="36">36</option><option value="custom">ì…ë ¥</option></select>
                        <div class="w-px h-5 bg-slate-300 mx-1"></div>
                        <button onclick="formatDoc('bold')" class="toolbar-btn"><i class="fa-solid fa-bold"></i></button>
                        <button onclick="formatDoc('italic')" class="toolbar-btn"><i class="fa-solid fa-italic"></i></button>
                        <button onclick="formatDoc('underline')" class="toolbar-btn"><i class="fa-solid fa-underline"></i></button>
                        <button onclick="formatDoc('strikeThrough')" class="toolbar-btn"><i class="fa-solid fa-strikethrough"></i></button>
                        <div class="w-px h-5 bg-slate-300 mx-1"></div>
                        <div class="toolbar-btn color-picker-wrapper" title="ê¸€ììƒ‰ ë³€ê²½">
                            <i class="fa-solid fa-font"></i><div class="w-1 h-1 rounded-full bg-indigo-500 absolute bottom-1.5 right-1.5"></div>
                            <input type="color" id="color-input" class="color-picker-input" oninput="applyColor(this.value)">
                        </div>
                        <div class="w-px h-5 bg-slate-300 mx-1"></div>
                        <button onclick="formatDoc('justifyLeft')" class="toolbar-btn"><i class="fa-solid fa-align-left"></i></button>
                        <button onclick="formatDoc('justifyCenter')" class="toolbar-btn"><i class="fa-solid fa-align-center"></i></button>
                        <button onclick="formatDoc('justifyRight')" class="toolbar-btn"><i class="fa-solid fa-align-right"></i></button>
                        <div class="w-px h-5 bg-slate-300 mx-1"></div>
                        <label class="toolbar-btn text-indigo-600 hover:text-indigo-700 bg-indigo-50 hover:bg-indigo-100" title="ì´ë¯¸ì§€ ì¶”ê°€">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <input type="file" accept="image/*" multiple class="hidden" onchange="uploadToAssets(this)">
                        </label>
                    </div>
                    <div id="editor" class="editor-content flex-1 overflow-y-auto bg-white" contenteditable="true" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
                    <div id="asset-area" class="px-6 py-4 border-t border-slate-200 bg-slate-50/50 flex flex-col gap-2">
                        <div class="flex justify-between items-end">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wide flex items-center gap-2"><i class="fa-regular fa-images"></i> ì²¨ë¶€ëœ ì´ë¯¸ì§€ <span id="asset-hint" class="text-[10px] font-normal text-slate-400 normal-case">(ìˆ˜ì • ëª¨ë“œì—ì„œ í´ë¦­í•˜ì—¬ ì‚½ì…)</span></p>
                            <span id="asset-count" class="text-xs text-slate-400">0ê°œ</span>
                        </div>
                        <div id="asset-list" class="flex gap-3 overflow-x-auto pb-2 pt-1 scrollbar-thin min-h-[90px] items-center"></div>
                    </div>
                    <div class="px-6 py-4 border-t border-slate-100 bg-white rounded-b-2xl flex flex-row-reverse gap-2">
                        <div id="btn-group-edit" class="flex gap-2 hidden">
                            <button onclick="saveMemo()" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg">ì €ì¥í•˜ê¸°</button>
                            <button onclick="switchToReadMode()" class="bg-white border border-slate-200 text-slate-600 px-6 py-2.5 rounded-xl font-bold hover:bg-slate-50 transition-all">ì·¨ì†Œ</button>
                        </div>
                        <div id="btn-group-read" class="flex gap-2">
                            <button onclick="switchToEditMode()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg flex items-center gap-2"><i class="fa-solid fa-pen"></i> ìˆ˜ì •í•˜ê¸°</button>
                            <button onclick="closeModal()" class="bg-white border border-slate-200 text-slate-600 px-6 py-2.5 rounded-xl font-bold hover:bg-slate-50 transition-all">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">í™˜ê²½ ì„¤ì •</h3>
                    <button onclick="closeSettings()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="space-y-6 overflow-y-auto pr-2 custom-scrollbar">
                    <!-- ë°±ì—… ì„¹ì…˜ -->
                    <div>
                        <h4 class="text-sm font-bold mb-2 text-slate-700">ğŸ’¾ ë°ì´í„° ë°±ì—…/ë³µêµ¬</h4>
                        <div class="flex gap-2">
                            <button onclick="exportData()" class="flex-1 bg-slate-100 hover:bg-slate-200 py-2.5 rounded-lg text-sm font-medium transition-colors">ë‚´ë³´ë‚´ê¸°</button>
                            <button onclick="triggerImport()" class="flex-1 bg-slate-100 hover:bg-slate-200 py-2.5 rounded-lg text-sm font-medium transition-colors">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="importData(this)">
                        </div>
                    </div>

                    <!-- í°íŠ¸ ì„¹ì…˜ -->
                    <div>
                        <h4 class="text-sm font-bold mb-2 text-slate-700">ğŸ…°ï¸ ì»¤ìŠ¤í…€ í°íŠ¸ ì¶”ê°€</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">í°íŠ¸ ì´ë¦„ (CSSì˜ font-familyì™€ ì¼ì¹˜í•´ì•¼ í•¨!)</label>
                                <input type="text" id="font-name-input" class="w-full border border-slate-200 rounded p-2.5 text-sm focus:border-indigo-500 outline-none" placeholder="ì˜ˆ: Paperozi">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">CSS ì½”ë“œ ë˜ëŠ” URL</label>
                                <textarea id="font-url-input" class="w-full border border-slate-200 rounded p-2.5 text-sm focus:border-indigo-500 outline-none h-24 resize-none" placeholder="@font-face { font-family: 'Paperozi'; ... }"></textarea>
                            </div>
                            <button onclick="addCustomFont()" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-indigo-700 transition-all">í°íŠ¸ ì¶”ê°€í•˜ê¸°</button>
                        </div>
                        
                        <div class="mt-4">
                            <p class="text-xs font-bold text-slate-400 mb-2">ë“±ë¡ëœ í°íŠ¸</p>
                            <ul id="saved-font-list" class="text-xs text-slate-600 space-y-2"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'MemoverseDB';
        const STORE_NAME = 'memos';
        const DB_VERSION = 3;
        
        let db;
        let useLocalStorage = false;
        let memos = []; 
        let customFonts = JSON.parse(localStorage.getItem('memoverse_custom_fonts')) || [];
        let editingId = null;
        let currentAssets = [];
        let currentCoverIndex = 0;
        let savedRange = null;
        let isEditMode = false;

        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', async () => {
            const dbPromise = initDB();
            const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve('TIMEOUT'), 800));

            try {
                const result = await Promise.race([dbPromise, timeoutPromise]);
                if (result === 'TIMEOUT') {
                    console.warn('DB Init timed out. Switching to LocalStorage.');
                    useLocalStorage = true;
                }
            } catch (e) {
                console.error('DB Init Failed:', e);
                useLocalStorage = true;
            }

            await loadMemosGeneric();
            loadCustomFonts();
            
            const loader = document.getElementById('loading-screen');
            if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
            updateStorageBadge();

            document.addEventListener('selectionchange', () => {
                const sel = window.getSelection();
                const editor = document.getElementById('editor');
                if (sel && sel.rangeCount > 0) {
                    const range = sel.getRangeAt(0);
                    if (editor && editor.contains(range.commonAncestorContainer)) savedRange = range.cloneRange();
                }
            });
        });

        function updateStorageBadge() {
            const badge = document.getElementById('storage-badge');
            if(useLocalStorage) {
                badge.innerText = 'Lite (Local)'; badge.className = 'text-xs font-normal bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full';
            } else {
                badge.innerText = 'Pro (DB)'; badge.className = 'text-xs font-normal bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full';
            }
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) return reject("IndexedDB not supported");
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (d.objectStoreNames.contains(STORE_NAME)) d.deleteObjectStore(STORE_NAME);
                    d.createObjectStore(STORE_NAME, { keyPath: 'id' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        async function loadMemosGeneric() {
            if (useLocalStorage) {
                try { memos = JSON.parse(localStorage.getItem('memoverse_final_memos')) || []; } catch(e) { memos = []; }
            } else { await loadMemosFromDB(); }
            renderMemos();
        }

        function loadMemosFromDB() {
            return new Promise((resolve) => {
                if(!db) { resolve(); return; }
                try {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => { memos = req.result ? req.result.sort((a, b) => b.id - a.id) : []; resolve(); };
                    req.onerror = () => { useLocalStorage = true; loadMemosGeneric(); resolve(); };
                } catch (e) { useLocalStorage = true; resolve(); }
            });
        }

        async function saveMemoGeneric(memo) {
            if (useLocalStorage) {
                const idx = memos.findIndex(m => m.id === memo.id);
                if (idx !== -1) memos[idx] = memo; else memos.unshift(memo);
                try { localStorage.setItem('memoverse_final_memos', JSON.stringify(memos)); } catch(e) { alert('ì €ì¥ ìš©ëŸ‰ ë¶€ì¡±!'); }
            } else { await saveMemoToDB(memo); await loadMemosFromDB(); }
        }

        function saveMemoToDB(memo) {
            return new Promise((resolve, reject) => {
                try {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).put(memo).onsuccess = () => resolve();
                    tx.onerror = (e) => reject(e);
                } catch(e) { reject(e); }
            });
        }

        async function deleteMemoGeneric(id) {
            if (useLocalStorage) {
                memos = memos.filter(m => m.id !== id);
                localStorage.setItem('memoverse_final_memos', JSON.stringify(memos));
            } else {
                await new Promise((resolve) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).delete(id).onsuccess = () => resolve();
                });
                await loadMemosFromDB();
            }
        }

        // --- í°íŠ¸ ê¸°ëŠ¥ (ìˆ˜ì •ë¨: ìŠ¤íƒ€ì¼ íƒœê·¸ ì£¼ì…) ---
        function addCustomFont() { 
            const n = document.getElementById('font-name-input').value.trim();
            const u = document.getElementById('font-url-input').value.trim();
            if(!n || !u) return alert('ì´ë¦„ê³¼ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            customFonts.push({name: n, url: u});
            localStorage.setItem('memoverse_custom_fonts', JSON.stringify(customFonts));
            
            loadCustomFonts();
            renderFonts();
            document.getElementById('font-name-input').value = '';
            document.getElementById('font-url-input').value = '';
        }

        function loadCustomFonts() {
            const container = document.getElementById('dynamic-fonts');
            const select = document.getElementById('fontFamilySelect');
            
            container.innerHTML = '';
            select.innerHTML = '<option value="" disabled selected>í°íŠ¸</option><option value="Noto Sans KR">ê¸°ë³¸ (Noto)</option><option value="serif">ë°”íƒ• (Serif)</option>';
            
            customFonts.forEach(f => {
                // [í•µì‹¬ ìˆ˜ì •] @font-faceë‚˜ { ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ <style>ë¡œ ì²˜ë¦¬
                if (f.url.includes('@font-face') || f.url.includes('{') || f.url.trim().startsWith('<')) {
                    const style = document.createElement('style');
                    style.innerHTML = f.url;
                    container.appendChild(style);
                } else {
                    // ì•„ë‹ˆë©´ ê¸°ì¡´ì²˜ëŸ¼ ë§í¬ë¡œ ì²˜ë¦¬
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = f.url;
                    container.appendChild(link);
                }
                
                const option = document.createElement('option');
                option.value = f.name; // ì—¬ê¸°ì„œ f.nameì€ ë°˜ë“œì‹œ CSS ë‚´ë¶€ font-familyì™€ ì¼ì¹˜í•´ì•¼ í•¨
                option.innerText = f.name;
                select.appendChild(option);
            });
        }

        function renderFonts() {
            const l = document.getElementById('saved-font-list'); l.innerHTML='';
            customFonts.forEach((f,i)=> l.innerHTML+=`<li class="flex justify-between bg-slate-100 p-2 rounded"><span>${f.name}</span><button onclick="delFont(${i})" class="text-red-400"><i class="fa-solid fa-trash"></i></button></li>`);
        }
        function delFont(i){ customFonts.splice(i,1); localStorage.setItem('memoverse_custom_fonts',JSON.stringify(customFonts)); loadCustomFonts(); renderFonts(); }

        // --- UI ë¡œì§ ---
        function openCreateModal() {
            editingId = null; document.getElementById('input-title').value = ''; document.getElementById('editor').innerHTML = '';
            currentAssets = []; currentCoverIndex = 0; savedRange = null; renderAssetList();
            document.getElementById('memo-modal').classList.remove('hidden'); switchToEditMode();
        }
        function openViewModal(id) {
            const m = memos.find(x => x.id === id); if (!m) return;
            editingId = id; document.getElementById('input-title').value = m.title; document.getElementById('editor').innerHTML = m.content;
            currentAssets = m.assets || []; currentCoverIndex = m.coverIndex || 0; renderAssetList();
            document.getElementById('memo-modal').classList.remove('hidden'); switchToReadMode();
        }
        function switchToEditMode() {
            isEditMode = true; document.getElementById('toolbar').classList.remove('hidden');
            document.getElementById('btn-group-edit').classList.remove('hidden'); document.getElementById('btn-group-read').classList.add('hidden');
            document.getElementById('asset-hint').innerText = "(ìˆ˜ì • ëª¨ë“œì—ì„œ í´ë¦­í•˜ì—¬ ì‚½ì…)";
            document.getElementById('editor').contentEditable = "true"; document.getElementById('input-title').readOnly = false; renderAssetList();
        }
        function switchToReadMode() {
            isEditMode = false;
            if(editingId) { const m = memos.find(x=>x.id===editingId); if(m){ document.getElementById('input-title').value=m.title; document.getElementById('editor').innerHTML=m.content; }}
            document.getElementById('toolbar').classList.add('hidden');
            document.getElementById('btn-group-edit').classList.add('hidden'); document.getElementById('btn-group-read').classList.remove('hidden');
            document.getElementById('asset-hint').innerText = "(ì½ê¸° ëª¨ë“œ)";
            document.getElementById('editor').contentEditable = "false"; document.getElementById('input-title').readOnly = true; renderAssetList();
        }
        function closeModal() { document.getElementById('memo-modal').classList.add('hidden'); }

        function uploadToAssets(input) {
            if (input.files && input.files.length > 0) {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => { currentAssets.push(e.target.result); renderAssetList(); };
                    reader.readAsDataURL(file);
                });
                input.value = '';
            }
        }
        function renderAssetList() {
            const list = document.getElementById('asset-list');
            document.getElementById('asset-count').innerText = `${currentAssets.length}ê°œ`;
            list.innerHTML = '';
            if (currentAssets.length === 0) {
                list.innerHTML = isEditMode ? `<div class="text-sm text-slate-400 w-full text-center py-4 border-2 border-dashed border-slate-200 rounded-lg">ì´ë¯¸ì§€ ì¶”ê°€</div>` : `<div class="text-sm text-slate-400 w-full text-center py-2">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
                return;
            }
            if (currentCoverIndex >= currentAssets.length) currentCoverIndex = 0;
            let html = '';
            currentAssets.forEach((src, idx) => {
                const isCover = (idx === currentCoverIndex);
                const onClick = isEditMode ? `onclick="insertImageFromAsset(${idx})"` : `onclick="alert('ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.')"`;
                const cursor = isEditMode ? 'cursor-pointer' : 'cursor-default';
                let btns = '';
                if (isEditMode) btns = `<button onclick="setCover(${idx}, event)" class="absolute top-1 left-1 w-6 h-6 rounded-full flex items-center justify-center ${isCover?'bg-indigo-600 text-white':'bg-black/50 text-slate-300'}"><i class="fa-solid fa-star text-[10px]"></i></button><button onclick="removeAsset(${idx}, event)" class="absolute top-1 right-1 bg-black/50 hover:bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100"><i class="fa-solid fa-xmark text-[10px]"></i></button>`;
                else if(isCover) btns = `<div class="absolute top-1 left-1 bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded">ëŒ€í‘œ</div>`;
                html += `<div class="asset-item relative shrink-0 group w-20 h-20 rounded-lg overflow-hidden bg-slate-200 ${cursor} ${isCover?'ring-2 ring-indigo-600':''}" ${onClick}><img src="${src}" class="w-full h-full object-cover opacity-90 hover:opacity-100 transition-opacity">${btns}</div>`;
            });
            list.innerHTML = html;
        }
        function insertImageFromAsset(idx) { restoreSelection(); document.execCommand('insertHTML', false, `<img src="${currentAssets[idx]}"><br>`); }
        function setCover(idx, e) { e.stopPropagation(); currentCoverIndex = idx; renderAssetList(); }
        function removeAsset(idx, e) { e.stopPropagation(); if(!confirm('ì œê±°?')) return; currentAssets.splice(idx, 1); if(currentCoverIndex>=currentAssets.length) currentCoverIndex=0; renderAssetList(); }

        function restoreSelection() {
            const editor = document.getElementById('editor'); editor.focus();
            if (savedRange) { const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(savedRange); }
        }
        function formatDoc(cmd, val) { restoreSelection(); document.execCommand(cmd, false, val); document.getElementById('editor').focus(); }
        function applyColor(c) { restoreSelection(); document.execCommand('foreColor', false, c); }
        function changeFontSize(s) {
            restoreSelection(); if(s==='custom') s=prompt('í¬ê¸°(px)', 16); if(!s) return;
            document.execCommand('fontSize', false, '7');
            const fonts = document.getElementById('editor').getElementsByTagName('font');
            for(let i=fonts.length-1; i>=0; i--){ if(fonts[i].getAttribute('size')==='7'){ const sp=document.createElement('span'); sp.style.fontSize=s+'px'; sp.innerHTML=fonts[i].innerHTML; fonts[i].parentNode.replaceChild(sp, fonts[i]); }}
        }

        async function saveMemo() {
            const t = document.getElementById('input-title').value.trim();
            const c = document.getElementById('editor').innerHTML;
            const tc = document.getElementById('editor').innerText.trim();
            if (!t && !tc && currentAssets.length === 0) return alert('ë‚´ìš© ì…ë ¥ í•„ìš”');
            const memo = { id: editingId || Date.now(), title: t, content: c, assets: currentAssets, coverIndex: currentCoverIndex, date: new Date().toLocaleString('ko-KR', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) };
            await saveMemoGeneric(memo); renderMemos(); closeModal();
        }
        async function deleteMemo(id, e) { e.stopPropagation(); if(!confirm('ì‚­ì œ?')) return; await deleteMemoGeneric(id); renderMemos(); }
        function renderMemos() {
            const grid = document.getElementById('memo-grid'), empty = document.getElementById('empty-state'); grid.innerHTML = '';
            if(memos.length===0) { grid.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            grid.classList.remove('hidden'); empty.classList.add('hidden');
            memos.forEach(m => {
                const div = document.createElement('div'); div.innerHTML = m.content;
                let cv = ''; if(m.assets?.length){ const i = (m.coverIndex>=0 && m.coverIndex<m.assets.length)?m.coverIndex:0; const ex = m.assets.length-1; cv=`<div class="h-44 w-full bg-slate-100 relative overflow-hidden border-b border-slate-100"><img src="${m.assets[i]}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">${ex>0?`<div class="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded">+${ex}</div>`:''}</div>`; }
                const card = document.createElement('div'); card.className = 'bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all h-[320px] flex flex-col cursor-pointer group'; card.onclick = () => openViewModal(m.id);
                card.innerHTML = `${cv}<div class="p-5 flex flex-col flex-1"><h3 class="font-bold text-lg mb-2 text-slate-900 line-clamp-1">${m.title||'ë¬´ì œ'}</h3><div class="text-sm text-slate-500 line-clamp-3 flex-1 leading-relaxed">${div.innerText.substring(0,150)||'<span class="text-slate-300">ë‚´ìš© ì—†ìŒ</span>'}</div><div class="flex justify-between items-center text-xs text-slate-400 mt-3 pt-3 border-t border-slate-50"><span>${m.date}</span><button onclick="deleteMemo(${m.id}, event)" class="hover:text-red-500 p-1.5 rounded-full"><i class="fa-regular fa-trash-can"></i></button></div></div>`;
                grid.appendChild(card);
            });
        }
        // ì„¤ì •
        function openSettings(){ document.getElementById('settings-modal').classList.remove('hidden'); renderFonts(); }
        function closeSettings(){ document.getElementById('settings-modal').classList.add('hidden'); }
        function exportData(){ if(memos.length===0) return alert('ì—†ìŒ'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(memos)],{type:'application/json'})); a.download=`backup_${Date.now()}.json`; a.click(); }
        function triggerImport(){ document.getElementById('import-file-input').click(); }
        function importData(i){ if(!i.files[0])return; const r=new FileReader(); r.onload=async e=>{ try{ const d=JSON.parse(e.target.result); if(useLocalStorage){memos=d;localStorage.setItem('memoverse_final_memos',JSON.stringify(memos));}else{const tx=db.transaction(STORE_NAME,'readwrite');d.forEach(m=>tx.objectStore(STORE_NAME).put(m));} await loadMemosGeneric(); alert('ì™„ë£Œ'); closeSettings(); }catch(e){alert('ì˜¤ë¥˜');} }; r.readAsText(i.files[0]); i.value=''; }
    </script>
</body>
</html>