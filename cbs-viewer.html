<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중괄호 구문 검사기</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        textarea {
            width: 100%;
            box-sizing: border-box; /* padding과 border가 width에 포함되도록 */
            height: 200px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        .result-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: white;
            min-height: 200px; /* 내용이 없어도 최소 높이 유지 */
        }
        .highlighted-content {
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.5;
            /* min-height: 100px; /* 하이라이트 내용 부분 최소 높이 */
            overflow-x: auto;
        }
        .unmatched {
            color: red;
            font-weight: bold;
            text-decoration: underline;
        }
        .color-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .color-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-box {
            width: 15px;
            height: 15px;
            border: 1px solid #333;
        }
        .instructions {
            background-color: #e9f7fe;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #0088cc;
        }
        /* --- 수정된/추가된 스타일 --- */
        #clear-button {
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            align-self: flex-start; /* 버튼을 왼쪽 정렬 */
            margin-bottom: 10px; /* 텍스트 영역과의 간격 */
        }
        #clear-button:hover {
            background-color: #c0392b;
        }
        .status-message { /* 기존 error-count에서 이름 변경 및 스타일 개선 */
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid transparent;
        }
        .status-message.success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .status-message.error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        /* --- --- */
    </style>
</head>
<body>
    <h1>중괄호 구문 검사기</h1>
    
    <div class="instructions">
        <h3>사용법</h3>
        <p>중괄호 구문을 아래 텍스트 영역에 입력하면 자동으로 분석됩니다:</p>
        <ul>
            <li>각 중괄호 쌍마다 다른 색상으로 표시됩니다.</li>
            <li>닫히지 않은 중괄호는 <span style="color: red; font-weight: bold;">빨간색</span>으로 표시됩니다 (짝이 없는 닫힌 중괄호).</li>
            <li>중첩된 중괄호는 다른 색상으로 구분됩니다.</li>
        </ul>
    </div>

    <div class="container">
        <!-- "전부 지우기" 버튼 추가 -->
        <button id="clear-button">전부 지우기</button>
        
        <textarea id="input-text" placeholder="중괄호 구문을 여기에 입력하세요. 예: {{#if {{equal::{{char}}::name}} }}{{/if}}"></textarea>
        
        <div class="result-container">
            <!-- 상태 메시지 위치 변경 -->
            <div class="status-message" id="status-message"></div>
            <div class="highlighted-content" id="highlighted-output"></div>
            <!-- 기존 error-count div는 status-message로 대체됨 -->
        </div>

        <div class="color-info" id="color-info">
            <div class="color-item">
                <div class="color-box" style="background-color: red;"></div>
                <span>닫히지 않은 중괄호 (짝 없는 닫힘)</span>
            </div>
        </div>
    </div>

    <script>
        const inputText = document.getElementById('input-text');
        const highlightedOutput = document.getElementById('highlighted-output');
        const statusMessage = document.getElementById('status-message'); // errorCount -> statusMessage
        const colorInfo = document.getElementById('color-info');
        const clearButton = document.getElementById('clear-button'); // "전부 지우기" 버튼
        
        inputText.value = '{{#if {{equal::{{char}}::name}} }}{{/if}}\n{{#if {{equal::{{char}}::name}}{{/if}}';
        
        const colors = [
            '#3498db', '#2ecc71', '#9b59b6', '#e67e22', '#f1c40f', 
            '#1abc9c', '#e74c3c', '#34495e', '#16a085', '#27ae60',
            '#8e44ad', '#d35400', '#c0392b', '#7f8c8d', '#2c3e50'
        ];
        
        function analyzeBraces(text) {
            let resultHtml = ''; // 변수명 변경 (result -> resultHtml)
            let stack = [];
            let colorStack = [];
            let unmatchedCount = 0;
            let usedColorPairs = {}; // { 'openPos-closePos': color }
            let colorIndex = 0;
            
            let openBracesPositions = []; // 닫히지 않은 열린 중괄호의 원본 텍스트 인덱스 저장용

            for (let i = 0; i < text.length; i++) {
                if (text[i] === '{' && text[i + 1] === '{') {
                    stack.push(i);
                    const currentColor = colors[colorIndex % colors.length];
                    colorStack.push(currentColor);
                    
                    resultHtml += `<span style="color: ${currentColor};">{{</span>`;
                    i++; 
                } else if (text[i] === '}' && text[i + 1] === '}') {
                    if (stack.length > 0) {
                        const openPos = stack.pop();
                        const color = colorStack.pop();
                        
                        const pairKey = `${openPos}-${i}`; // 키는 고유해야 함
                        usedColorPairs[pairKey] = color;
                        
                        resultHtml += `<span style="color: ${color};">}}</span>`;
                        // 매칭된 후에는 colorIndex를 변경하여 다음 중첩 레벨 (또는 동일 레벨의 다음 쌍)이 다른 색을 갖도록 함
                        // 중첩이 끝나고 새로운 쌍이 시작될 때 색상이 바뀌도록 하는 것이 의도라면,
                        // 스택이 비었을 때 닫는 괄호를 만나면 colorIndex를 초기화하거나 다음으로 넘겨야 함.
                        // 현재 로직: 닫는 괄호를 만나면 다음 열린 괄호 색이 바뀜
                        colorIndex++; 
                    } else {
                        resultHtml += `<span class="unmatched">}}</span>`;
                        unmatchedCount++;
                    }
                    i++;
                } else {
                    if (text[i] === '\n') {
                        resultHtml += '<br>';
                    } else {
                        resultHtml += text[i].replace(/[&<>"']/g, function (match) { // HTML 특수문자 이스케이프
                            return {
                                '&': '&',
                                '<': '<',
                                '>': '>',
                                '"': '"',
                                "'": '''
                            }[match];
                        });
                    }
                }
            }
            
            // 닫히지 않은 열린 중괄호 처리
            while (stack.length > 0) {
                const pos = stack.pop();
                openBracesPositions.push(pos); // 닫히지 않은 열린 중괄호 위치 저장
                unmatchedCount++;
                // 닫히지 않은 열린 중괄호는 resultHtml에서 특별히 스타일을 바꾸지 않고,
                // 상태 메시지로 위치를 알려줌. (사용법 설명과 약간 다름)
            }
            
            updateColorInfo(usedColorPairs);
            
            return { 
                html: resultHtml, 
                unmatchedCount,
                unmatchedOpenBracesPos: openBracesPositions.reverse() // 순서를 원래대로
            };
        }
        
        function updateColorInfo(usedColors) {
            colorInfo.innerHTML = ''; // 초기화
            
            const unmatchedColorItem = document.createElement('div');
            unmatchedColorItem.className = 'color-item';
            unmatchedColorItem.innerHTML = `
                <div class="color-box" style="background-color: red;"></div>
                <span>짝 없는 닫힌 중괄호</span>
            `;
            colorInfo.appendChild(unmatchedColorItem);
            
            const uniqueColors = [...new Set(Object.values(usedColors))];
            uniqueColors.forEach((color, index) => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.innerHTML = `
                    <div class="color-box" style="background-color: ${color};"></div>
                    <span>중괄호 쌍 ${index + 1}</span>
                `;
                colorInfo.appendChild(colorItem);
            });
        }
        
        function reanalyzeText() {
            const text = inputText.value;
            const analysisResult = analyzeBraces(text); // 변수명 변경 (result -> analysisResult)
            
            highlightedOutput.innerHTML = analysisResult.html;
            
            statusMessage.classList.remove('success', 'error'); // 이전 상태 클래스 제거
            statusMessage.textContent = ''; // 메시지 초기화

            if (analysisResult.unmatchedCount > 0) {
                statusMessage.classList.add('error');
                let message = `오류: 짝이 맞지 않는 중괄호가 ${analysisResult.unmatchedCount}개 있습니다.`;
                
                if (analysisResult.unmatchedOpenBracesPos.length > 0) {
                    let unmatchedPositionsText = [];
                    analysisResult.unmatchedOpenBracesPos.forEach(pos => {
                        let line = 1;
                        let col = 1;
                        for (let i = 0; i < pos; i++) {
                            if (text[i] === '\n') {
                                line++;
                                col = 1;
                            } else {
                                col++;
                            }
                        }
                        unmatchedPositionsText.push(`'{{' (L${line},C${col})`);
                    });
                    message += ` 닫히지 않은 열린 중괄호 위치: ${unmatchedPositionsText.join(', ')}`;
                }
                statusMessage.textContent = message;

            } else {
                if (text.trim() === '') { // 입력이 비어있거나 공백만 있을 경우
                    statusMessage.textContent = '분석할 내용이 없습니다. 중괄호 구문을 입력해주세요.';
                    // 특별한 클래스 없이 기본 스타일로 표시하거나, info 클래스 등을 추가할 수 있음
                } else {
                    statusMessage.classList.add('success');
                    statusMessage.textContent = '모든 중괄호가 올바르게 짝을 이루고 있습니다.';
                }
            }
        }

        // "전부 지우기" 버튼 이벤트 리스너
        clearButton.addEventListener('click', () => {
            inputText.value = '';
            reanalyzeText(); // 분석 함수 호출하여 모든 관련 UI 업데이트
        });
        
        reanalyzeText(); // 초기 분석
        inputText.addEventListener('input', reanalyzeText);
    </script>
</body>
</html>
