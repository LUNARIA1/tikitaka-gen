<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중괄호 구문 검사기</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        textarea {
            width: 100%;
            box-sizing: border-box; /* padding과 border가 width에 포함되도록 */
            height: 200px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        .result-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: white;
            min-height: 200px; /* 내용이 없어도 최소 높이 유지 */
        }
        .highlighted-content {
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.5;
            overflow-x: auto;
        }
        .unmatched {
            color: red;
            font-weight: bold;
            text-decoration: underline;
        }
        .color-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .color-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-box {
            width: 15px;
            height: 15px;
            border: 1px solid #333;
        }
        .instructions {
            background-color: #e9f7fe;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #0088cc;
        }
        #clear-button {
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            align-self: flex-start; 
            margin-bottom: 10px; 
        }
        #clear-button:hover {
            background-color: #c0392b;
        }
        .status-message { 
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid transparent;
        }
        .status-message.success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .status-message.error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>중괄호 구문 검사기</h1>
    
    <div class="instructions">
        <h3>사용법</h3>
        <p>중괄호 구문을 아래 텍스트 영역에 입력하면 자동으로 분석됩니다:</p>
        <ul>
            <li>각 중괄호 쌍마다 다른 색상으로 표시됩니다.</li>
            <li>닫히지 않은 중괄호는 <span style="color: red; font-weight: bold;">빨간색</span>으로 표시됩니다 (짝이 없는 닫힌 중괄호).</li>
            <li>중첩된 중괄호는 다른 색상으로 구분됩니다.</li>
        </ul>
    </div>

    <div class="container">
        <button id="clear-button">전부 지우기</button>
        
        <textarea id="input-text" placeholder="중괄호 구문을 여기에 입력하세요. 예: {{#if {{equal::{{char}}::name}} }}{{/if}}"></textarea>
        
        <div class="result-container">
            <div class="status-message" id="status-message"></div>
            <div class="highlighted-content" id="highlighted-output"></div>
        </div>

        <div class="color-info" id="color-info">
            <div class="color-item">
                <div class="color-box" style="background-color: red;"></div>
                <span>짝 없는 닫힌 중괄호</span>
            </div>
        </div>
    </div>

    <script>
        console.log('Script execution started.'); 

        const inputText = document.getElementById('input-text');
        const highlightedOutput = document.getElementById('highlighted-output');
        const statusMessage = document.getElementById('status-message'); 
        const colorInfo = document.getElementById('color-info');
        const clearButton = document.getElementById('clear-button'); 
        
        // DOM 요소들이 제대로 선택되었는지 확인
        if (!inputText || !highlightedOutput || !statusMessage || !colorInfo || !clearButton) {
            console.error('Error: One or more DOM elements not found. Check IDs in HTML and JavaScript.');
            // 스크립트 실행을 중단하거나, 사용자에게 알림을 줄 수 있습니다.
            // 여기서는 이후 로직이 DOM 요소에 의존하므로, 더 이상 진행하지 않는 것이 안전할 수 있습니다.
            // alert('페이지 구성 요소를 찾을 수 없어 스크립트를 실행할 수 없습니다.');
        } else {
            console.log('All DOM elements successfully found.');
            
            inputText.value = '{{#if {{equal::{{char}}::name}} }}{{/if}}\n{{#if {{equal::{{char}}::name}}{{/if}}';
            console.log('Initial text set to textarea.');
            
            const colors = [
                '#3498db', '#2ecc71', '#9b59b6', '#e67e22', '#f1c40f', 
                '#1abc9c', '#e74c3c', '#34495e', '#16a085', '#27ae60',
                '#8e44ad', '#d35400', '#c0392b', '#7f8c8d', '#2c3e50'
            ];
            
            function escapeHtml(char) {
                const map = {
                    '&': '&',
                    '<': '<',
                    '>': '>',
                    '"': '"',
                    "'": '''
                };
                return map[char] || char;
            }

            function analyzeBraces(text) {
                console.log('analyzeBraces called with text length:', text.length);
                let resultHtml = ''; 
                let stack = [];
                let colorStack = [];
                let unmatchedCount = 0;
                let usedColorPairs = {}; 
                let colorIndex = 0;
                let openBracesPositions = []; 

                for (let i = 0; i < text.length; i++) {
                    if (text[i] === '{' && i + 1 < text.length && text[i + 1] === '{') {
                        stack.push(i);
                        const currentColor = colors[colorIndex % colors.length];
                        colorStack.push(currentColor);
                        resultHtml += `<span style="color: ${currentColor};">{{</span>`;
                        i++; 
                    } else if (text[i] === '}' && i + 1 < text.length && text[i + 1] === '}') {
                        if (stack.length > 0) {
                            const openPos = stack.pop();
                            const color = colorStack.pop();
                            const pairKey = `${openPos}-${i}`; 
                            usedColorPairs[pairKey] = color;
                            resultHtml += `<span style="color: ${color};">}}</span>`;
                            colorIndex++; 
                        } else {
                            resultHtml += `<span class="unmatched">}}</span>`;
                            unmatchedCount++;
                        }
                        i++;
                    } else {
                        if (text[i] === '\n') {
                            resultHtml += '<br>';
                        } else {
                            resultHtml += escapeHtml(text[i]); 
                        }
                    }
                }
                
                while (stack.length > 0) {
                    const pos = stack.pop();
                    openBracesPositions.push(pos); 
                    unmatchedCount++;
                }
                
                updateColorInfo(usedColorPairs);
                
                const analysisResult = { 
                    html: resultHtml, 
                    unmatchedCount,
                    unmatchedOpenBracesPos: openBracesPositions.reverse() 
                };
                console.log('analyzeBraces result - HTML length:', analysisResult.html.length, 'Unmatched:', analysisResult.unmatchedCount);
                return analysisResult;
            }
            
            function updateColorInfo(usedColors) {
                console.log('updateColorInfo called.');
                colorInfo.innerHTML = ''; 
                
                const unmatchedColorItem = document.createElement('div');
                unmatchedColorItem.className = 'color-item';
                unmatchedColorItem.innerHTML = `
                    <div class="color-box" style="background-color: red;"></div>
                    <span>짝 없는 닫힌 중괄호</span>
                `;
                colorInfo.appendChild(unmatchedColorItem);
                
                const uniqueColors = [...new Set(Object.values(usedColors))];
                uniqueColors.forEach((color, index) => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.innerHTML = `
                        <div class="color-box" style="background-color: ${color};"></div>
                        <span>중괄호 쌍 ${index + 1}</span>
                    `;
                    colorInfo.appendChild(colorItem);
                });
            }
            
            function reanalyzeText() {
                console.log('reanalyzeText called.');
                const text = inputText.value;
                console.log('Text to analyze length:', text.length);
                
                const analysisResult = analyzeBraces(text); 
                
                highlightedOutput.innerHTML = analysisResult.html;
                console.log('Highlighted output updated.');
                
                statusMessage.className = 'status-message'; 
                statusMessage.textContent = ''; 

                if (analysisResult.unmatchedCount > 0) {
                    statusMessage.classList.add('error');
                    let message = `오류: 짝이 맞지 않는 중괄호가 ${analysisResult.unmatchedCount}개 있습니다.`;
                    
                    if (analysisResult.unmatchedOpenBracesPos.length > 0) {
                        let unmatchedPositionsText = [];
                        analysisResult.unmatchedOpenBracesPos.forEach(pos => {
                            let line = 1;
                            let col = 1;
                            for (let i = 0; i < pos; i++) {
                                if (text[i] === '\n') {
                                    line++;
                                    col = 1;
                                } else {
                                    col++;
                                }
                            }
                            unmatchedPositionsText.push(`'{{' (L${line},C${col})`);
                        });
                        message += ` 닫히지 않은 열린 중괄호 위치: ${unmatchedPositionsText.join(', ')}`;
                    }
                    statusMessage.textContent = message;

                } else {
                    if (text.trim() === '') { 
                        statusMessage.textContent = '분석할 내용이 없습니다. 중괄호 구문을 입력해주세요.';
                    } else {
                        statusMessage.classList.add('success');
                        statusMessage.textContent = '모든 중괄호가 올바르게 짝을 이루고 있습니다.';
                    }
                }
                console.log('Status message updated:', statusMessage.textContent);
            }

            clearButton.addEventListener('click', () => {
                console.log('Clear button clicked.');
                inputText.value = '';
                reanalyzeText(); 
            });
            
            inputText.addEventListener('input', () => {
                console.log('Input event triggered.');
                reanalyzeText();
            });
            
            console.log('Performing initial analysis.');
            reanalyzeText(); // 초기 분석
        }

        console.log('Script execution finished.');
    </script>
</body>
</html>
